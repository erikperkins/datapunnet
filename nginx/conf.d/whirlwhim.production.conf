upstream rails {
  server rails;
}

upstream flask {
  server 52.36.236.17;
}

upstream snap {
  server snap;
}

upstream scalatra {
  server scalatra;
}

upstream golang {
  server golang;
}

upstream iron {
  server iron;
}

upstream phoenix {
  server 52.38.13.88;
}

upstream rabbitmq {
  server 52.38.13.88:15672;
}

server {
  listen 80 default_server;
  server_name _;
  root /rails_app/;

  location /cable {
    proxy_pass http://rails/cable;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Origin "nginx";
  }

  location /socket {
    proxy_pass http://phoenix/socket;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Origin "nginx";
  }

  location /messages/ {
    proxy_pass http://rabbitmq/;
  }

  location /flask/ {
    proxy_pass http://flask/;
    proxy_set_header Host $host;
  }

  location /scalatra/ {
    proxy_pass http://scalatra/;
    proxy_set_header Host $host;
  }

  location /snap/ {
    proxy_pass http://snap/;
    proxy_set_header Host $host;
  }

  location /golang/ {
    proxy_pass http://golang/;
    proxy_set_header Host $host;
  }

  location /iron/ {
    proxy_pass http://iron/;
    proxy_set_header Host $host;
  }

  location /phoenix/ {
    allow all;

    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Cluster-Client-Ip $remote_addr;

    proxy_set_header Upgrade $http_uprade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://phoenix/;
  }

  location / {
    proxy_pass http://rails;
    proxy_set_header CLIENT_IP $remote_addr;
  }

  location /assets/ {
    gzip_static on;
    alias /var/www/public/assets/;
  }

  location /public/ {
    gzip_static on;
    alias /var/www/public/;
  }

  location /js/ {
    gzip_static on;
    proxy_pass http://phoenix/js/;
  }

  location /css/ {
    gzip_static on;
    proxy_pass http://phoenix/css/;
  }

  location /images/ {
    gzip_static on;
    proxy_pass http://phoenix/images/;
  }

  location /fonts/ {
    gzip_static on;
    proxy_pass http://phoenix/fonts/;
  }

}
